steps:
# Install
- name: 'gcr.io/cloud-builders/npm'
  dir: 'client'
  args: ['install']
  id: CLIENT_INSTALL
  waitFor: ['-']

- name: 'gcr.io/cloud-builders/npm'
  dir: 'client'
  args: ['run','test:unit']
  id: CLIENT_TEST
  waitFor:
    - CLIENT_INSTALL

- name: 'gcr.io/cloud-builders/npm'
  dir: 'client'
  args: ['run','build', '--prod']
  id: CLIENT_BUILD
  env:
      - 'VUE_APP_FIREBASE_API_KEY:$_FIREBASE_API_KEY'
      - 'VUE_APP_FIREBASE_AUTH_DOMAIN:$_FIREBASE_AUTH_DOMAIN'
      - 'VUE_APP_FIREBASE_DATABASE_URL:$_FIREBASE_DATABASE_URL'
      - 'VUE_APP_FIREBASE_PROJECT_ID:$_FIREBASE_PROJECT_ID'
      - 'VUE_APP_FIREBASE_STORAGE_BUCKET:$_FIREBASE_STORAGE_BUCKET'
      - 'VUE_APP_FIREBASE_MESSAGE_SENDER_ID:$_FIREBASE_SENDER_ID'
      - 'VUE_APP_FIREBASE_APP_ID:$_FIREBASE_APP_ID'
  waitFor:
    - CLIENT_TEST
  options:
    substitution_option: 'ALLOW_LOOSE'

- name: 'gcr.io/cloud-builders/npm'
  dir: 'admin-site'
  args: ['install']
  id: ADMIN_INSTALL
  waitFor: ['-']

- name: 'gcr.io/cloud-builders/npm'
  dir: 'admin-site'
  args: ['run','build', '--prod']
  id: ADMIN_BUILD
  env:
      - 'VUE_APP_FIREBASE_API_KEY:$_FIREBASE_API_KEY'
      - 'VUE_APP_FIREBASE_AUTH_DOMAIN:$_FIREBASE_AUTH_DOMAIN'
      - 'VUE_APP_FIREBASE_DATABASE_URL:$_FIREBASE_DATABASE_URL'
      - 'VUE_APP_FIREBASE_PROJECT_ID:$_FIREBASE_PROJECT_ID'
      - 'VUE_APP_FIREBASE_STORAGE_BUCKET:$_FIREBASE_STORAGE_BUCKET'
      - 'VUE_APP_FIREBASE_MESSAGE_SENDER_ID:$_FIREBASE_SENDER_ID'
      - 'VUE_APP_FIREBASE_APP_ID:$_FIREBASE_APP_ID'
  waitFor:
    - ADMIN_INSTALL
  options:
    substitution_option: 'ALLOW_LOOSE'

- name: 'gcr.io/cloud-builders/npm'
  dir: 'functions'
  args: ['install']
  id: FUNCTIONS_INSTALL
  waitFor: ['-']

- name: 'gcr.io/$PROJECT_ID/firebase'
  args: ['deploy']
  waitFor:
    - FUNCTIONS_INSTALL
    - ADMIN_BUILD
    - CLIENT_BUILD